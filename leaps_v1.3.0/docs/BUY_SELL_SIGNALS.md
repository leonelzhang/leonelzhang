# Leaps 买卖信号功能说明

## 功能概述

Leaps系统现已集成智能买卖信号功能，当股价突破或跌破指定时间周期内的关键价格水平时，在图表上自动标注买入(B)和卖出(S)信号。

## 工作原理

### 买入信号 (B)
- **触发条件**: 
  1. 股价突破近期指定时间周期的最高价
  2. **MACD指标位于0轴以上**（新增过滤条件）
- **显示方式**: 绿色向上三角形标记 (▲) + "B"文字标注
- **含义**: 价格创新高且处于上升趋势，可能进入上涨趋势
- **过滤逻辑**: 只有在MACD > 0时才显示买入信号，避免在下跌趋势中买入

### 卖出信号 (S)
- **触发条件**: 
  1. 股价跌破近期指定时间周期的最低价
  2. **MACD指标位于0轴以下**（新增过滤条件）
- **显示方式**: 红色向下三角形标记 (▼) + "S"文字标注
- **含义**: 价格创新低且处于下降趋势，可能进入下跌趋势
- **过滤逻辑**: 只有在MACD < 0时才显示卖出信号，避免在上涨趋势中卖出

## 信号周期选项

系统支持以下信号周期：

| 周期选项 | 交易日数 | 适用场景 |
|---------|----------|---------|
| 1mo | 20天 | 短期交易，捕捉短期突破 |
| 3mo | 60天 | 中期交易，平衡风险和收益 |
| 6mo | 120天 | 中长期趋势跟踪 |
| 1y | 250天 | 长期趋势确认 |

## 使用方法

### 1. 启用买卖信号
在控制面板中勾选 "买卖信号" 选项（默认已启用）

### 2. 选择信号周期
从 "信号周期" 下拉菜单中选择合适的时间周期：
- 短线交易者：选择 1mo
- 中线交易者：选择 3mo 或 6mo
- 长线投资者：选择 1y

### 3. 获取数据
点击 "获取数据" 按钮，系统会自动计算并显示买卖信号

### 4. 查看信号
在图表上查看：
- 绿色▲标记 + "B" = 买入信号
- 红色▼标记 + "S" = 卖出信号

## 信号计算逻辑

```python
# 计算MACD指标
close_prices = hist['Close']
ema12 = close_prices.ewm(span=12, adjust=False).mean()
ema26 = close_prices.ewm(span=26, adjust=False).mean()
macd_line = ema12 - ema26

# 计算滚动最高价和最低价
rolling_high = hist['High'].rolling(window=period).max()
rolling_low = hist['Low'].rolling(window=period).min()

# 检测突破（结合MACD过滤）
if current_high > previous_rolling_high and current_macd > 0:
    生成买入信号

# 检测跌破（结合MACD过滤）
if current_low < previous_rolling_low and current_macd < 0:
    生成卖出信号
```

### MACD过滤机制

系统会自动计算MACD指标，并根据MACD的位置过滤买卖信号：

- **买入信号过滤**: 只有当 `MACD > 0` 时，价格突破才会生成买入信号
- **卖出信号过滤**: 只有当 `MACD < 0` 时，价格跌破才会生成卖出信号

这种过滤机制可以有效避免：
- 在下跌趋势中（MACD < 0）错误地买入
- 在上涨趋势中（MACD > 0）错误地卖出

## 界面布局

```
┌─────────────────────────────────────────┐
│  控制面板                            │
│  ┌─────────────────────────────┐      │
│  │ 股票代码: AAPL          │      │
│  │ 时间周期: 1y             │      │
│  │ 数据间隔: 1d             │      │
│  │ 图表类型: line           │      │
│  │ 显示选项:                │      │
│  │ ☑ 移动平均线            │      │
│  │ ☑ 成交量               │      │
│  │ ☑ 布林带               │      │
│  │ ☑ 买卖信号              │ ← 新增
│  │ 信号周期: 1mo           │ ← 新增
│  │ [获取][刷新][保存][导出]  │      │
│  └─────────────────────────────┘      │
└─────────────────────────────────────────┘
```

## 图表示例

```
价格 ($)
  ↑
  │        ▲ B        ▲ B
  │       / \       / \
  │      /   \     /   \
  │     /     \   /     \
  │    /       \ /       \   ▼ S
  │   /         X         \ /
  │  /         / \         X
  │ /         /   \       / \
  │/         /     \     /   \
  └─────────────────────────────→ 时间
```

## 技术分析原理

### 突破买入 (Breakout)
- 当价格突破前期高点时，通常意味着：
  - 买盘力量增强
  - 可能进入新的上涨阶段
  - 技术阻力被突破

### 跌破卖出 (Breakdown)
- 当价格跌破前期低点时，通常意味着：
  - 卖盘压力增大
  - 可能进入下跌阶段
  - 技术支撑被击穿

## 信号特点

### 优势
- **客观性**: 基于历史价格数据，无主观判断
- **及时性**: 在突破/跌破发生时立即提示
- **可视化**: 直观显示在图表上
- **灵活性**: 可调整周期适应不同交易风格
- **智能过滤**: 结合MACD指标过滤，提高信号准确性

### MACD过滤优势
- **避免逆势交易**: 不在下跌趋势中买入，不在上涨趋势中卖出
- **提高胜率**: 只在趋势方向正确时给出信号
- **减少假信号**: 过滤掉不符合趋势方向的突破/跌破
- **顺势而为**: 始终跟随主要趋势方向

### 注意事项
- **滞后性**: 基于历史数据，信号有一定滞后
- **假突破**: 可能出现假突破/跌破信号
- **趋势市场**: 在震荡市场中信号较少（因为MACD过滤）
- **配合使用**: 建议结合其他技术指标综合判断
- **MACD依赖**: 信号质量依赖于MACD指标的准确性

## 最佳实践

### 1. 周期选择
- **短线交易**: 使用 1mo 周期，捕捉短期突破
- **波段操作**: 使用 3mo 周期，平衡频率和准确性
- **趋势跟踪**: 使用 6mo 或 1y 周期，过滤短期噪音

### 2. 信号确认
- 结合成交量确认突破有效性
- 观察移动平均线方向
- 关注布林带位置

### 3. 风险管理
- 设置止损位
- 控制仓位大小
- 避免追高杀跌

### 4. 多指标配合
- 移动平均线：判断趋势方向
- 布林带：评估波动率
- 成交量：确认突破力度

## 常见问题

### Q: 为什么会有连续的买入/卖出信号？
A: 在强势趋势中，价格可能连续创出新高/新低，产生连续信号。

### Q: 信号周期如何选择？
A: 根据你的交易周期选择。短线选1mo，中线选3mo，长线选6mo或1y。

### Q: 信号100%准确吗？
A: 不是。这是基于历史数据的参考信号，需结合其他分析方法和风险管理。

### Q: 如何提高信号质量？
A: 
1. 选择合适的信号周期
2. 结合其他技术指标
3. 观察成交量变化
4. 设置止损保护

## 代码实现

信号检测的核心代码（包含MACD过滤）：

```python
def plot_buy_sell_signals(self, hist):
    signal_period = self.signal_period_var.get()
    
    period_days = {
        '1mo': 20,
        '3mo': 60,
        '6mo': 120,
        '1y': 250
    }
    
    window = period_days.get(signal_period, 20)
    
    # 计算MACD指标
    close_prices = hist['Close']
    ema12 = close_prices.ewm(span=12, adjust=False).mean()
    ema26 = close_prices.ewm(span=26, adjust=False).mean()
    macd_line = ema12 - ema26
    
    # 计算滚动最高价和最低价
    rolling_high = hist['High'].rolling(window=window).max()
    rolling_low = hist['Low'].rolling(window=window).min()
    
    buy_signals = []
    sell_signals = []
    
    for i in range(window, len(hist)):
        current_high = hist['High'].iloc[i]
        current_low = hist['Low'].iloc[i]
        current_macd = macd_line.iloc[i]
        
        prev_rolling_high = rolling_high.iloc[i-1]
        prev_rolling_low = rolling_low.iloc[i-1]
        
        # 买入信号：价格突破 且 MACD > 0
        if current_high > prev_rolling_high and current_macd > 0:
            buy_signals.append((hist.index[i], current_high))
        
        # 卖出信号：价格跌破 且 MACD < 0
        if current_low < prev_rolling_low and current_macd < 0:
            sell_signals.append((hist.index[i], current_low))
```

## 更新日志

### v1.2.0 (2026-02-16)
- ✨ 新增MACD过滤机制
- 🎯 买入信号：仅在MACD > 0时显示
- 🎯 卖出信号：仅在MACD < 0时显示
- 📈 提高信号准确性，避免逆势交易
- ⚙️ 自动计算MACD指标进行过滤

### v1.1.0 (2026-02-16)
- ✨ 新增买卖信号功能
- 📊 支持多种信号周期选择
- 🎯 自动标注B/S信号
- 🖼️ 可视化显示突破和跌破点
- ⚙️ 可开关信号显示

## 免责声明

买卖信号仅供参考，不构成投资建议。投资有风险，入市需谨慎。请结合自身情况独立判断。
